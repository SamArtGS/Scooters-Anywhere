-- Companía:  Scooters Anywhere
-- Project:   Modelo Proyecto Final
-- Author:    Garrido Samuel y Jorge Cárdenas
-- Fecha:     04 de Junio del 2020

CREATE TABLE USUARIO(
  USUARIO_ID  NUMBER(10,0)  NOT NULL,
  EMAIL       VARCHAR2(40)  NOT NULL,
  NOMBRE      VARCHAR2(40)  NOT NULL,
  AP_PATERNO  VARCHAR2(40)  NOT NULL,
  AP_MATERNO  VARCHAR2(40)  NOT NULL,
  PASSWORD    VARCHAR2(70)  NOT NULL,
  PUNTOS      NUMBER(10,0)  DEFAULT 0 NOT NULL,
  CONSTRAINT USUARIO_PK PRIMARY KEY (USUARIO_ID),
  CONSTRAINT USUARIO_EMAIL_CHK CHECK(REGEXP_LIKE (EMAIL, '^(\S+)\@(\S+)\.(\S+)$')),
  CONSTRAINT USUARIO_PASSWORD_CHK CHECK (LENGTH(PASSWORD) >= 8),
  CONSTRAINT USUARIO_EMAIL_UK UNIQUE(EMAIL)
);

CREATE TABLE TARJETA_PREPAGO(
  TARJETA_PREPAGO_ID  NUMBER(10,0)  NOT NULL,
  CODIGO_BARRAS       NUMBER(21,0)  NOT NULL,
  FECHA_REGISTRO      DATE,
  FECHA_EXPIRACION    DATE,
  IMPORTE             NUMBER(4,0)   NOT NULL,
  USUARIO_ID          NUMBER(10,0),
  CONSTRAINT TARJETA_PREPAGO_PK PRIMARY KEY (TARJETA_PREPAGO_ID),
  CONSTRAINT TARJETA_PREPAGO_USUARIO_ID_FK FOREIGN KEY (USUARIO_ID)
  REFERENCES USUARIO(USUARIO_ID),
  CONSTRAINT TARJ_PREPAGO_CODIGO_BARRAS_UK UNIQUE(CODIGO_BARRAS)
);

--EL AÑO DE EXPIRACIÓN DEBE VERIFICARSE CON UN TRIGGER O CAUSARÁ DISRUNPURA DE LA BASE ALGÚN DÍA.
--SE ME OCURRE PONERLE UN ATRIBUTO DE "ESTÁ ACTIVA O NO"
--NO SÉ SI EL CÓDIGO DE BARRAS SEA ÚNICO.

CREATE TABLE TARJETA_CLIENTE(
  USUARIO_ID       NUMBER(10,0) NOT NULL,
  NUMERO_TARJETA   NUMBER(19,0) NOT NULL,
  MES_EXPIRACION   NUMBER(2,0)  NOT NULL,
  ANIO_EXPIRACION  NUMBER(2,0)  NOT NULL,
  CONSTRAINT TARJETA_CLIENTE_PK PRIMARY KEY (USUARIO_ID),
  CONSTRAINT TARJ_CLIENTE_USUARIO_ID_FK FOREIGN KEY (USUARIO_ID)
  REFERENCES USUARIO(USUARIO_ID),
  CONSTRAINT TARJ_CLIENTE_NUM_TARJETA_CHK
  CHECK(NUMERO_TARJETA BETWEEN 1000000000000 AND 9999999999999999999),
  CONSTRAINT TARJ_CLIENTE_ANIO_EXP_CHK
  CHECK(MES_EXPIRACION BETWEEN 1 AND 12),
  CONSTRAINT TARJ_CLIENTE_NUM_TARJETA_UK UNIQUE(NUMERO_TARJETA)
);

CREATE TABLE MARCA(
  MARCA_ID  NUMBER(10,0)  NOT NULL,
  NOMBRE    VARCHAR2(50)  NOT NULL,
  CONSTRAINT MARCA_PK PRIMARY KEY (MARCA_ID),
  CONSTRAINT STATUS_NOMBRE_UK UNIQUE(NOMBRE)
);


CREATE TABLE TELEFONO_MARCA(
  TELEFONO_MARCA_ID  NUMBER(10,0)  NOT NULL,
  MARCA_ID           NUMBER(10,0)  NOT NULL,
  TELEFONO           NUMBER(15,0)  NOT NULL,
  CONSTRAINT TELEFONO_MARCA_PK PRIMARY KEY (TELEFONO_MARCA_ID),
  CONSTRAINT TELEFONO_MARCA_MARCA_ID_FK FOREIGN KEY (MARCA_ID)
  REFERENCES MARCA(MARCA_ID),
  CONSTRAINT TELEFONO_MARCA_TELEFONO_UK UNIQUE(TELEFONO)
);

CREATE TABLE STATUS(
  STATUS_ID    NUMBER(10,0)   NOT NULL,
  CLAVE        VARCHAR2(40)   NOT NULL,
  DESCRIPCION  VARCHAR2(255)  NOT NULL,
  CONSTRAINT STATUS_PK PRIMARY KEY (STATUS_ID),
  CONSTRAINT STATUS_CLAVE_UK UNIQUE(CLAVE)
);

CREATE TABLE SCOOTER(
  SCOOTER_ID            NUMBER(10,0)  NOT NULL,
  NUMERO_SERIE          NUMBER(20,0)  NOT NULL,
  MATRICULA             VARCHAR2(20)  NOT NULL,
  CODIGO_ACCESO         VARCHAR2(50)  NOT NULL,
  CAPACIDAD_MAXIMA      NUMBER(3,0)   NOT NULL,
  FECHA_STATUS          DATE          NOT NULL,
  MARCA_ID              NUMBER(10,0)  NOT NULL,
  STATUS_ID             NUMBER(10,0)  NOT NULL,
  SCOOTER_REEMPLAZO_ID  NUMBER(10,0),
  CONSTRAINT SCOOTER_PK PRIMARY KEY (SCOOTER_ID),
  CONSTRAINT SCOOTER_MARCA_ID_FK FOREIGN KEY (MARCA_ID)
  REFERENCES MARCA(MARCA_ID),
  CONSTRAINT SCOOTER_STATUS_ID_FK FOREIGN KEY (STATUS_ID)
  REFERENCES STATUS(STATUS_ID),
  CONSTRAINT SCOOTER_SCOOTER_REEMPLAZO_ID FOREIGN KEY (SCOOTER_REEMPLAZO_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT SCOOTER_NUMERO_SERIE_UK UNIQUE(NUMERO_SERIE),
  CONSTRAINT SCOOTER_MATRICULA_UK UNIQUE(MATRICULA),
  CONSTRAINT SCOOTER_CODIGO_ACCESO_UK UNIQUE(CODIGO_ACCESO)
);

CREATE TABLE UBICACION(
  UBICACION_ID  NUMBER(10,0)  NOT NULL,
  LATITUD       NUMBER(8,5)   NOT NULL,
  LONGITUD      NUMBER(8,5)   NOT NULL,
  FECHA_HORA    DATE          DEFAULT SYSDATE NOT NULL,
  SCOOTER_ID    NUMBER(10,0)  NOT NULL,
  CONSTRAINT UBICACION_PK PRIMARY KEY (UBICACION_ID),
  CONSTRAINT UBICACION_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT UBICACION_LATITUD_CHK CHECK (LATITUD BETWEEN -90 AND 90),
  CONSTRAINT UBICACION_LONGITUD_CHK CHECK (LONGITUD BETWEEN -180 AND 180)
);



CREATE TABLE ZONA_SCOOTER(
    ZONA_ID     NUMBER(10,0)  NOT NULL,
    SCOOTER_ID  NUMBER(10,0)  NOT NULL,
    CONSTRAINT ZONA_SCOOTER_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
    REFERENCES SCOOTER(SCOOTER_ID)
);

CREATE TABLE HIST_SCOOTER_STATUS(
  HIST_SCOO_STATUS_ID     NUMBER(10,0)  NOT NULL,
  STATUS_ID               NUMBER(10,0)  NOT NULL,
  SCOOTER_ID              NUMBER(10,0)  NOT NULL,
  FECHA_STATUS            DATE          NOT NULL,
  CONSTRAINT HIST_SCOOTER_STATUS_PK PRIMARY KEY (HIST_SCOO_STATUS_ID),
  CONSTRAINT HIST_SCO_ST_STATUS_ID_FK FOREIGN KEY (STATUS_ID)
  REFERENCES STATUS(STATUS_ID),
  CONSTRAINT HIST_SCO_ST_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID)
);

CREATE TABLE REPORTE_FALLA(
  REPORTE_FALLA_ID    NUMBER(10,0)    NOT NULL,
  FECHA_REPORTE       DATE            NOT NULL,
  LATITUD             NUMBER(8,5),
  LONGITUD            NUMBER(8,5),
  DESCRIPCION         VARCHAR2(2000)  NOT NULL,
  USUARIO_ID          NUMBER(10,0)    NOT NULL,
  SCOOTER_ID          NUMBER(10,0)    NOT NULL,
  CONSTRAINT REPORTE_FALLA_PK PRIMARY KEY (REPORTE_FALLA_ID),
  CONSTRAINT REPORTE_FALLA_USUARIO_ID_FK FOREIGN KEY (USUARIO_ID)
  REFERENCES USUARIO(USUARIO_ID),
  CONSTRAINT REPORTE_FALLA_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT REPORTE_FALLA_LATITUD_CHK CHECK (LATITUD BETWEEN -90 AND 90),
  CONSTRAINT REPORTE_FALLA_LONGITUD_CHK CHECK (LONGITUD BETWEEN -180 AND 180)
);

CREATE TABLE IMAGEN_REPORTE(
  IMAGEN_REPORTE_ID    NUMBER(10,0)   NOT NULL,
  IMAGEN               BLOB           NOT NULL,
  REPORTE_FALLA_ID     NUMBER(10,0)   NOT NULL,
  CONSTRAINT IMAGEN_REPORTE_PK PRIMARY KEY (IMAGEN_REPORTE_ID),
  CONSTRAINT IMG_REP_REPORTE_FALLA_ID_FK FOREIGN KEY (REPORTE_FALLA_ID)
  REFERENCES REPORTE_FALLA(REPORTE_FALLA_ID)
);


CREATE TABLE SERVICIO(
  SERVICIO_ID        NUMBER(10,0)  NOT NULL,
  USUARIO_ID         NUMBER(10,0)  NOT NULL,
  PRECIO             NUMBER(9,2)   NOT NULL,
  FECHA_INICIO       DATE          DEFAULT SYSDATE NOT NULL,
  FECHA_FIN          DATE          NOT NULL,
  TIPO_SERVICIO      CHAR(1)       NOT NULL,
  CONSTRAINT SERVICIO_PK PRIMARY KEY (SERVICIO_ID),
  CONSTRAINT SERV_TIPO_SERVICIO_CHK CHECK(
    (TIPO_SERVICIO = 'V' AND FECHA_FIN <= FECHA_INICIO + 8/24) OR 
    (TIPO_SERVICIO = 'R' AND FECHA_FIN <= FECHA_INICIO + 15) 
    OR TIPO_SERVICIO = 'B')
);

CREATE TABLE SERVICIO_VIAJE(
  SERVICIO_ID   NUMBER(10,0)  NOT NULL,
  FOLIO         VARCHAR2(13)  NOT NULL,
  SCOOTER_ID    NUMBER(10,0)  NOT NULL,
  CONSTRAINT SERVICIO_VIAJE_PK PRIMARY KEY (SERVICIO_ID),
  CONSTRAINT SERV_VIAJE_SERVICIO_ID_FK FOREIGN KEY (SERVICIO_ID)
  REFERENCES SERVICIO(SERVICIO_ID),
  CONSTRAINT SERV_VIAJE_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT SERVICIO_VIAJE_FOLIO_UK UNIQUE(FOLIO)
);

--CONSTRAINT SERV_VIAJE_FECHA_FIN_CHK CHECK FECHA_FIN <= FECHA_INICIO + 8/24
--TENDRÍA QUE SER CON UN TRIGGER.

CREATE TABLE SERVICIO_RENTA(
  SERVICIO_ID    NUMBER(10,0)   NOT NULL,
  DIRECCION      VARCHAR2(255)  NOT NULL,
  DIAS_CUSTODIA  NUMBER(2,0)    NOT NULL,
  SCOOTER_ID     NUMBER(10,0)   NOT NULL,
  CONSTRAINT SERVICIO_RENTA_PK PRIMARY KEY (SERVICIO_ID),
  CONSTRAINT SERV_RENT_SERVICIO_ID_FK FOREIGN KEY (SERVICIO_ID)
  REFERENCES SERVICIO(SERVICIO_ID),
  CONSTRAINT SERV_RENT_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT SERV_RENT_DIAS_CUSTODIA_CHK CHECK(DIAS_CUSTODIA < 15)
);

CREATE TABLE SERVICIO_RECARGA(
  SERVICIO_ID            NUMBER(10,0)  NOT NULL,
  NOMBRE_BANCO           VARCHAR2(50)  NOT NULL,
  CLABE_INTERBANCARIA    NUMBER(18,0)  NOT NULL,
  CONSTRAINT SERVICIO_RECARGA_PK PRIMARY KEY (SERVICIO_ID),
  CONSTRAINT SERV_RECARGA_SERVICIO_ID_FK FOREIGN KEY (SERVICIO_ID)
  REFERENCES SERVICIO(SERVICIO_ID)
);
--http://omawww.sat.gob.mx/fichas_tematicas/buzon_tributario/Documents/catalogo_bancos.pdf
--checar el documento de las claves interbancarias para poner ese mega check
-- INDICE UNIQUE ENTRE CLABE INTERBANCARIA CON USUARIO?

CREATE TABLE RECARGA_SCOOTER(
  SERVICIO_ID    NUMBER(10,0)  NOT NULL,
  SCOOTER_ID     NUMBER(10,0)  NOT NULL,
  NIVEL_CARGA    NUMBER(3,0)   NOT NULL,
  CONSTRAINT RECARGA_SCOOTER_PK PRIMARY KEY (SERVICIO_ID, SCOOTER_ID),
  CONSTRAINT REC_SCO_SERVICIO_ID_FK FOREIGN KEY (SERVICIO_ID)
  REFERENCES SERVICIO_RECARGA(SERVICIO_ID),
  CONSTRAINT REC_SCO_SCOOTER_ID_FK FOREIGN KEY (SCOOTER_ID)
  REFERENCES SCOOTER(SCOOTER_ID),
  CONSTRAINT REC_SCO_NIVEL_CARGA_CHK
  CHECK(NIVEL_CARGA BETWEEN 0 AND 100)
);
