-- Companía:  Scooters Anywhere
-- Project:   Modelo Proyecto Final
-- Author:    Garrido Samuel y Jorge Cárdenas
-- Fecha:     04 de Junio del 2020

/*
Necesidades para iniciar un servicio: 
    
*/

CREATE OR REPLACE TRIGGER INICIAR_SERVICIO AFTER INSERT ON SERVICIO
  FOR EACH ROW
DECLARE
  E_EXCEPTION_1 EXCEPTION;
  E_ERROR_INMUEBLE EXCEPTION;
  V_CLIENTE_AVAL NUMBER;

SELECT INMUEBLE_ID,CLIENTE_ID,STATUS_INMUEBLE_ID FROM INMUEBLE WHERE CLIENTE_ID = P_AVAL_CLIENTE;
  V_PAGADO NUMBER;
BEGIN
    IF :NEW.CLIENTE_ID IS NULL AND :NEW.STATUS_INMUEBLE_ID = 1 THEN DBMS_OUTPUT.PUT_LINE('');
    ELSIF :NEW.CLIENTE_ID IS NOT NULL
    AND :NEW.STATUS_INMUEBLE_ID > 1
    AND :NEW.STATUS_INMUEBLE_ID != 5 THEN
    SELECT AVAL_CLIENTE_ID INTO V_CLIENTE_AVAL FROM CLIENTE
    WHERE :NEW.CLIENTE_ID = CLIENTE.CLIENTE_ID; V_PAGADO := 0;
    FOR R IN CUR_INMUEBLES_AVAL(V_CLIENTE_AVAL) LOOP IF R.STATUS_INMUEBLE_ID = 5 THEN
    V_PAGADO := 1; END IF;
    END LOOP;
    IF V_PAGADO = 0 THEN
    INSERT INTO ASIGNACION_PENDIENTE
    VALUES (SEQ_ASIGNACION_PENDIENTE.NEXTVAL,
    'EL CLIENTE Y AVAL NO TIENEN PROPIEDADES', SYSDATE,
    :NEW.INMUEBLE_ID,:NEW.CLIENTE_ID, :NEW.STATUS_INMUEBLE_ID);
            RAISE E_ERROR_AVAL_SIN_PROPIEDAD;
        END IF;
    ELSIF :NEW.CLIENTE_ID IS NOT NULL AND :NEW.STATUS_INMUEBLE_ID = 5 THEN
    DBMS_OUTPUT.PUT_LINE(''); ELSE
    RAISE E_ERROR_INMUEBLE; END IF;
    EXCEPTION
    WHEN E_ERROR_AVAL_SIN_PROPIEDAD THEN
    RAISE_APPLICATION_ERROR(-20012,'AVAL Y CLIENTE DEL PUEBLO BUENO Y SABIO'); WHEN E_ERROR_INMUEBLE THEN
    RAISE_APPLICATION_ERROR(-20010,'NO ESTÁ DISPONIBLE EL INMUEBLE'); END;
    /
SHOW ERRORS;